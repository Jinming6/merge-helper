!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash")):"function"==typeof define&&define.amd?define(["exports","lodash"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@jinming6/mergeHelper"]={},e._)}(this,(function(e,t){"use strict";const o="_mergeOpts",s="_sortNo",i="_firstId",r="id";var n,l=Object.freeze({__proto__:null,FIRST_ID:i,MERGE_OPTS_KEY:o,ROW_KEY:r,SORT_NO_KEY:s});function c(e){console.warn(`[@jinming6/merge-helper warn] ${e}`)}function a(e,s){const i=e[o],r={rowspan:1,colspan:1};if(!t.isPlainObject(i))return r;const n=i[s];return t.isPlainObject(n)?n:r}function g(e){if(e.length<1)return c("mergeFields should not be empty"),null;const o=e[0];return t.isString(o)?o:t.isPlainObject(o)?o.field:null}e.Mode=void 0,(n=e.Mode||(e.Mode={}))[n.Row=0]="Row",n[n.Col=1]="Col",n[n.RowCol=2]="RowCol";class d{constructor(o){this.mode=e.Mode.Row;const{dataSource:s,mergeFields:i,genSort:n,rowKey:l=r,columns:a=[],mode:d,sortBy:h}=o;this.mode=d,this.dataSource=t.cloneDeep(s),this.mergeFields=t.cloneDeep(i),this.genSort=null!=n&&n,this.rowKey=l,this.columns=a,this.sortBy=t.isString(h)?h:g(this.mergeFields),this.initMergeOpts(this.dataSource,this.mergeFields),this.mode===e.Mode.Row?this.mergeCells(this.dataSource):this.mode===e.Mode.Col?(console.log("columns",this.columns),this.columns.length<1&&c("columns should not be empty"),this.mergeCols(this.dataSource,this.columns)):this.mode===e.Mode.RowCol&&(this.mergeCells(this.dataSource),this.mergeCols(this.dataSource,this.columns))}initMergeOpts(e,s){s.forEach((s=>{const i=t.isString(s)?s:s.field;if(!t.isString(i))throw new Error("field 必须是一个字符串");e.forEach((e=>{t.isPlainObject(e[o])||(e[o]={}),t.isPlainObject(e[o][i])||(e[o][i]={rowspan:1,colspan:1})}))}))}isMergedCell(e,s){const i=e[o][s];return t.isPlainObject(i)&&0===i.rowspan}mergeCells(e){this.mergeFields.forEach((o=>{if(t.isString(o))this.mergeCellsByField(e,o);else if(t.isPlainObject(o)){const{field:s,callback:i}=o;t.isString(s)&&t.isFunction(i)&&this.mergeCellsByField(e,s,i)}}))}mergeCellsByField(e,r,n){if(!t.isString(r))return;let l=1;for(let c=0;c<e.length;c++){const a=e[c];if(!this.isMergedCell(a,r)){t.isBoolean(this.genSort)&&this.sortBy===r&&(a[s]=l);for(let s=c+1;s<e.length;s++){const l=e[s];if(!(t.isFunction(n)?n(a,l):a[r]===l[r]))break;a[o][r].rowspan+=1,l[o][r].rowspan=0,l[i]=t.isString(this.rowKey)?a[this.rowKey]:null}this.sortBy===r&&(l+=1)}}}mergeCols(e,t){if(t.length<1||e.length<1)return;const i=e.length,r=t.length;for(let n=0;n<i;n++){const i=e[n];for(let e=0;e<r;e++){const n=t[e];if(n.prop!==s&&(null!=i[n.prop]&&0!==i[o][n.prop].colspan))for(let l=e+1;l<r;l++){const e=t[l];if(e.prop===s)break;if(null==i[e.prop])break;if(i[n.prop]!==i[e.prop]||i[o][n.prop].rowspan!==i[o][e.prop].rowspan)break;i[o][n.prop].colspan+=1,i[o][e.prop].colspan=0}}}}getMergedData(){return this.dataSource}}e.CellMerger=d,e.constants=l,e.getFieldSpan=a,e.getMergedData=function(e){return new d(e).getMergedData()},e.splitIntoFragments=function(e){const{dataSource:o,pageSize:i,mergeFields:r,mode:n,genSort:l,sortBy:c,columns:h}=e,p=t.cloneDeep(o),u=Math.ceil(p.length/i);let f=[];for(let e=0;e<u;e++){const t=e*i,o=(e+1)*i,s=p.slice(t,o);f.push(s)}let m=!1;if(t.isArray(r)&&r.length>0&&(f=f.map((e=>new d({mode:n,dataSource:e,mergeFields:r,columns:h}).getMergedData())),m=!0),!0===l){const e=t.isString(c)?c:g(r);if(!t.isString(e))return f;let o=1;f.forEach((t=>{t.forEach((t=>{m?a(t,e).rowspan>0&&(t[s]=o,++o):(t[s]=o,o++)}))}))}return f}}));
