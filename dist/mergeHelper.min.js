!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash")):"function"==typeof define&&define.amd?define(["exports","lodash"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@jinming6/mergeHelper"]={},e._)}(this,(function(e,t){"use strict";const o="_mergeOpts",s="_sortNo",r="_firstId",i="id";var n,l=Object.freeze({__proto__:null,FIRST_ID:r,MERGE_OPTS_KEY:o,ROW_KEY:i,SORT_NO_KEY:s});function c(e,s){const r=e[o],i={rowspan:1,colspan:1};if(!t.isPlainObject(r))return i;const n=r[s];return t.isPlainObject(n)?n:i}function a(e){const o=e[0];return t.isString(o)?o:t.isPlainObject(o)?o.field:null}e.Mode=void 0,(n=e.Mode||(e.Mode={}))[n.Row=0]="Row",n[n.Col=1]="Col",n[n.RowCol=2]="RowCol";class g{constructor(o){this.mode=e.Mode.Row;const{dataSource:s,mergeFields:r,genSort:n,rowKey:l=i,columns:c=[],mode:g,sortBy:d}=o;var h;this.mode=g,this.dataSource=t.cloneDeep(s),this.mergeFields=t.cloneDeep(r),this.genSort=null!=n&&n,this.rowKey=l,this.columns=c,this.sortBy=t.isString(d)?d:a(this.mergeFields),this.initMergeOpts(this.dataSource,this.mergeFields),this.mode===e.Mode.Row?this.mergeCells(this.dataSource):this.mode===e.Mode.Col?(console.log("columns",this.columns),this.columns.length<1&&(h="columns 不能为空",console.warn(`[@jinming6/merge-helper warn] ${h}`)),this.mergeCols(this.dataSource,this.columns)):this.mode===e.Mode.RowCol&&(this.mergeCells(this.dataSource),this.mergeCols(this.dataSource,this.columns))}initMergeOpts(e,s){s.forEach((s=>{const r=t.isString(s)?s:s.field;if(!t.isString(r))throw new Error("field 必须是一个字符串");e.forEach((e=>{t.isPlainObject(e[o])||(e[o]={}),t.isPlainObject(e[o][r])||(e[o][r]={rowspan:1,colspan:1})}))}))}isMergedCell(e,s){const r=e[o][s];return t.isPlainObject(r)&&0===r.rowspan}mergeCells(e){this.mergeFields.forEach((o=>{if(t.isString(o))this.mergeCellsByField(e,o);else if(t.isPlainObject(o)){const{field:s,callback:r}=o;t.isString(s)&&t.isFunction(r)&&this.mergeCellsByField(e,s,r)}}))}mergeCellsByField(e,i,n){if(!t.isString(i))return;let l=1;for(let c=0;c<e.length;c++){const a=e[c];if(!this.isMergedCell(a,i)){t.isBoolean(this.genSort)&&this.sortBy===i&&(a[s]=l);for(let s=c+1;s<e.length;s++){const l=e[s];if(!(t.isFunction(n)?n(a,l):a[i]===l[i]))break;a[o][i].rowspan+=1,l[o][i].rowspan=0,l[r]=t.isString(this.rowKey)?a[this.rowKey]:null}this.sortBy===i&&(l+=1)}}}mergeCols(e,t){if(t.length<1||e.length<1)return;const r=e.length,i=t.length;for(let n=0;n<r;n++){const r=e[n];for(let e=0;e<i;e++){const n=t[e];if(n.prop!==s&&(null!=r[n.prop]&&0!==r[o][n.prop].colspan))for(let l=e+1;l<i;l++){const e=t[l];if(e.prop===s)break;if(null==r[e.prop])break;if(r[n.prop]!==r[e.prop]||r[o][n.prop].rowspan!==r[o][e.prop].rowspan)break;r[o][n.prop].colspan+=1,r[o][e.prop].colspan=0}}}}getMergedData(){return this.dataSource}}e.CellMerger=g,e.constants=l,e.getFieldSpan=c,e.getMergedData=function(e){return new g(e).getMergedData()},e.splitIntoFragments=function(e){const{dataSource:o,pageSize:r,mergeFields:i,mode:n,genSort:l,sortBy:d,columns:h}=e,p=t.cloneDeep(o),u=Math.ceil(p.length/r);let f=[];for(let e=0;e<u;e++){const t=e*r,o=(e+1)*r,s=p.slice(t,o);f.push(s)}let m=!1;if(t.isArray(i)&&i.length>0&&(f=f.map((e=>new g({mode:n,dataSource:e,mergeFields:i,columns:h}).getMergedData())),m=!0),!0===l){const e=t.isString(d)?d:a(i);if(!t.isString(e))return f;let o=1;f.forEach((t=>{t.forEach((t=>{m?c(t,e).rowspan>0&&(t[s]=o,++o):(t[s]=o,o++)}))}))}return f}}));
